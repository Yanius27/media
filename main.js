!function(){"use strict";class e{constructor(e,t){this._media=e,this._type=t,this._element,this.#e()}#e(){const e=document.createElement("div");e.classList.add("custom-controls"),e.classList.add(`custom-controls_${this._type}`);const t=document.createElement("div");t.classList.add("play-button");const s=document.createElement("div");s.classList.add("seek-bar");const a=document.createElement("input");a.classList.add("seek-bar-range"),a.setAttribute("type","range"),a.setAttribute("min",0),a.setAttribute("value",this._media.currentTime),a.setAttribute("step",1),s.append(a),e.append(t,s),this._element=e}get element(){return this._element}}class t{constructor(e,t,s){this._content=e,this._type=t,this._coords=s,this._element,this._currentDate,this.#t(),this.#s()}#t(){const e=new Date,t=e.getDate()<10?"0"+e.getDate():e.getDate(),s=e.getMonth()<10?"0"+(e.getMonth()+1):e.getMonth()+1,a=e.getFullYear(),n=e.getHours()<10?"0"+e.getHours():e.getHours(),o=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes();this._currentDate=`${t}.${s}.${a} ${n}:${o}`}#s(){const t=document.createElement("div");t.classList.add("card");const s=document.createElement("div");s.classList.add("flex");const a=document.createElement("div");if(a.classList.add("content"),"text"===this._type)a.textContent=this._content;else if("video"===this._type){const t=document.createElement("video");t.classList.add("media"),t.classList.add("videoFile");const s=new e(t,"video").element;t.setAttribute("poster","https://img.freepik.com/free-photo/white-background_23-2147730801.jpg"),t.src=URL.createObjectURL(this._content),a.append(t,s)}else{const t=document.createElement("audio");t.classList.add("media"),t.classList.add("audioFile");const s=new e(t,"audio").element;t.src=URL.createObjectURL(this._content),a.append(t,s)}const n=document.createElement("span");n.classList.add("date"),n.textContent=this._currentDate,s.append(a,n);const o=document.createElement("span");o.classList.add("coords");const[i,r]=this._coords;o.textContent=`[${i}, ${r}] ${String.fromCodePoint(128065)}`,t.append(s,o),this._element=t}get element(){return this._element}}class s{constructor(){this._element,this.#e()}#e(){const e=document.createElement("div");e.classList.add("popup");const t=document.createElement("h5");t.classList.add("popup_title"),t.textContent="Что-то пошло не так";const s=document.createElement("span");s.classList.add("popup_message"),s.textContent="К сожалению нам не удалось определить ваше местоположение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную.";const a=document.createElement("form");a.setAttribute("novalidate",""),a.classList.add("popup_form");const n=document.createElement("label");n.classList.add("popup_label");const o=document.createElement("span");o.classList.add("popup_inputSpan"),o.textContent="Широта и долгота через запятую";const i=document.createElement("input");i.classList.add("popup_input"),i.setAttribute("required",""),i.setAttribute("pattern","^(-|−)?\\d+(\\.\\d{1,5})?,\\s?(-|−)?\\d+(\\.\\d{1,5})?$|^\\[(-|−)?\\d+(\\.\\d{1,5})?,\\s?(-|−)?\\d+(\\.\\d{1,5})?\\]$"),n.append(o,i);const r=document.createElement("div");r.classList.add("popup_buttons");const c=document.createElement("input");c.type="submit",c.classList.add("popup_okBtn"),c.classList.add("popup_btn"),c.textContent="Ok";const d=document.createElement("button");d.classList.add("popup_cancelBtn"),d.classList.add("popup_btn"),d.textContent="Отмена",r.append(c,d),a.append(n,r),e.append(t,s,a),this._element=e}get element(){return this._element}}new class{constructor(){this._coords,this.initCoords(),this.messages=document.querySelector(".messages"),this.input=document.querySelector(".textInput"),this.videoPlayer=document.querySelector(".videoPlayer"),this.actualContentType,this.stream,this.recorder,this.blob,this.messageListener(),this.popup=(new s).element,this.popupListener(),this.recordListener()}initCoords(){!this._coords&&localStorage.getItem("coords")&&(this._coords=JSON.parse(localStorage.getItem("coords")))}saveCoords(){localStorage.setItem("coords",JSON.stringify(this._coords))}getCoords(){return new Promise(((e,t)=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((t=>{const{latitude:s,longitude:a}=t.coords;this._coords=[s.toFixed(5),a.toFixed(5)],this.saveCoords(),e(this._coords)}),(e=>{console.log(e),t(e)}),{enableHighAccuracy:!0}):t(new Error("Geolocation is not supported"))}))}async createCard(e,s,a){try{a||(this._coords=await this.getCoords());let n=new t(e,s,this._coords).element;if("text"!==s){let e=document.querySelector(".timing").textContent.split(":");e=60*e[0].replace("0","")+ +e[1]+.5,n.setAttribute("duration",e),n.addEventListener("click",this.messagePlayerListener),this.mediaListener(n)}this.messages.append(n)}catch(e){console.error("Failed to get coordinates:",e),document.body.append(this.popup)}}recordListener(){[...document.querySelectorAll(".btn")].forEach((e=>{e.addEventListener("click",(e=>{this.recorder.stop(),this.stream.getTracks().forEach((e=>e.stop())),this.videoPlayer.style.display="none",document.querySelector(".player").style.display="none",document.querySelector(".icons").style.display="flex",e.target.classList.contains("ok")&&this.recorder.stop()}))}))}timer(){const e=new Date,t=setInterval((()=>{const t=new Date,s=new Date(t-e),a=s.getMinutes(),n=s.getSeconds(),o=`${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`;document.querySelector(".timing").textContent=o}),1e3);return function(){clearInterval(t)}}messageListener(){let e;this.input.addEventListener("keydown",(async e=>{"Enter"===e.key&&""!==this.input.value&&(this.actualContentType="text",this.createCard(this.input.value,this.actualContentType,this._coords))})),[...document.querySelectorAll(".icon")].forEach((t=>{t.addEventListener("click",(async t=>{this.actualContentType=t.target.className.replace(" icon","");try{if(this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),this.stream){t.target.classList.contains("video")&&(this.videoPlayer.style.display="block",this.videoPlayer.muted=!0,this.videoPlayer.srcObject=this.stream),document.querySelector(".icons").style.display="none",document.querySelector(".player").style.display="flex",this.recorder=new MediaRecorder(this.stream,{mimeType:"video/webm; codecs=vp9"}),this.recorder.start(),this.videoPlayer.addEventListener("canplay",(()=>{this.videoPlayer.play()})),e=this.timer();const s=[];this.recorder.addEventListener("dataavailable",(function(e){s.push(e.data)})),this.recorder.addEventListener("stop",(async()=>{e(),this.blob=new Blob(s),this.createCard(this.blob,this.actualContentType,this._coords)}))}}catch(e){console.log("Пожалуйста, дайте разрешение для записи видео и аудио")}}))}))}popupListener(){this.popup.querySelector(".popup_buttons").addEventListener("click",(e=>{e.target.classList.contains("popup_cancelBtn")&&this.popup.remove()})),this.popup.querySelector(".popup_form").addEventListener("submit",(e=>{e.preventDefault(),this.checkInput(e.target.querySelector(".popup_input").value,this.actualContentType)}))}messagePlayerListener(e){const t=e.target.closest(".card").querySelector(".media");"play-button"===e.target.className?(this.actualContentType=t.className.replace("media ","").replace(" icon","").replace("File",""),e.target.classList.add(`${this.actualContentType}_pause`),t.play()):e.target.className===`play-button ${this.actualContentType}_pause`&&(this.actualContentType=t.className.replace("media ","").replace(" icon","").replace("File",""),e.target.classList.remove(`${this.actualContentType}_pause`),t.pause())}mediaListener(e){const t=e.querySelector(".media"),s=e.querySelector(".play-button"),a=e.querySelector(".seek-bar-range"),n=e.getAttribute("duration")?e.getAttribute("duration"):1;t.addEventListener("timeupdate",(()=>{const e=t.currentTime/n*100;a.value=e})),t.addEventListener("ended",(()=>{this.actualContentType=t.className.replace("media ","").replace(" icon","").replace("File",""),s.classList.remove(`${this.actualContentType}_pause`),a.value=0})),a.addEventListener("input",(e=>{const s=+e.target.value/100*n;t.currentTime=s}))}checkInput(e,t){try{if(!this.input.checkValidity())throw new Error("Введите корректное значение координат.");this.popup.remove(),this._coords=e.replace(/[\[\]\s]/g,"").split(","),this.saveCoords(),"text"!==t?this.createCard(this.blob,t,this._coords):this.createCard(this.input.value,t,this._coords)}catch(e){console.log(e),this.input.setCustomValidity(e.message),this.input.reportValidity(),setTimeout((()=>{this.input.setCustomValidity(""),this.input.reportValidity()}),3e3)}}}}();
//# sourceMappingURL=main.js.map